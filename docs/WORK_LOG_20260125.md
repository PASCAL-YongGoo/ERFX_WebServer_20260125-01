# ERFX WebServer 작업 로그 - 2026-01-25

## 개요

ERFX WebServer 프로젝트에 Blazor UI와 실시간 MQTT 연동 기능을 구현했습니다.

---

## 1. Blazor UI 구현

### 1.1 Dashboard 페이지 (`/`)
- **파일**: `Pages/Index.razor`
- **기능**: 검사 통계 카드 표시
  - 전체 검사 수
  - 오늘 검사 수
  - OK/NG 수량
  - 성공률 (%)

### 1.2 Inspections 페이지 (`/inspections`)
- **파일**: `Pages/Inspections.razor`
- **기능**: 검사 결과 목록 조회
  - 페이징 지원 (페이지당 20건)
  - 결과별 색상 구분 (OK: 초록, NG: 빨강)
  - 상세 정보 표시 (송장번호, 기대/실제 수량, 검사 시간)

### 1.3 Live Monitor 페이지 (`/live`)
- **파일**: `Pages/Live.razor`
- **기능**: 실시간 검사 결과 모니터링
  - MQTT 연결 상태 표시
  - 최신 검사 결과 대형 카드
  - 차이점(Differences) 테이블
  - 최근 20건 이력 목록

### 1.4 다크 테마 CSS
- **파일**: `wwwroot/css/site.css`
- **스타일**: 산업용 모니터링 다크 테마
  - 배경: #0f172a (슬레이트)
  - 카드: #1e293b
  - OK: #10b981 (에메랄드)
  - NG: #ef4444 (레드)

---

## 2. 실시간 MQTT + SignalR 연동

### 2.1 SignalR Hub
- **파일**: `Hubs/InspectionHub.cs`
- **메서드**:
  - `InspectionResult` - 검사 결과 브로드캐스트
  - `MqttConnected` - MQTT 연결 상태 브로드캐스트

### 2.2 MQTT Client Service
- **파일**: `Services/MqttClientService.cs`
- **기능**:
  - MQTTnet 5.0 API 사용
  - `erfx/inspector/result` 토픽 구독
  - 수신 메시지 → SignalR 브로드캐스트
  - 자동 재연결 (5초 간격)
- **라이브러리**: MQTTnet 5.0.1.1416

### 2.3 Program.cs 수정
- SignalR 서비스 등록
- MqttClientService (HostedService) 등록
- `/inspectionhub` 엔드포인트 매핑

---

## 3. 패키지 추가

| 패키지 | 버전 | 용도 |
|--------|------|------|
| Microsoft.AspNetCore.SignalR.Client | 10.0.2 | Blazor SignalR 클라이언트 |
| MQTTnet | 5.0.1.1416 | MQTT 클라이언트 (이미 추가됨) |

---

## 4. MQTTnet v5 마이그레이션

MQTTnet v4 → v5 API 변경사항 적용:

| v4 | v5 |
|----|-----|
| `MqttFactory` | `MqttClientFactory` |
| `MQTTnet.Client` namespace | `MQTTnet` namespace |
| `MQTTnet.Protocol.MqttQualityOfServiceLevel` | `MQTTnet.Protocol` (별도 using 필요) |
| `PayloadSegment` (getter) | `Payload` |

---

## 5. 기타 수정사항

### 5.1 InspectionService
- `GetTotalCountAsync()` 메서드 추가 (페이징용)

### 5.2 NavMenu.razor
- Dashboard, Inspections, Live 링크 추가

### 5.3 README.md
- ERFX_Integration 공유 문서 안내 추가
- Blazor UI 섹션 추가
- 기술 스택 업데이트

---

## 6. ERFX_Integration 문서 업데이트

### 6.1 README.md
- ERFX_WebServer 프로젝트 추가

### 6.2 Integration_Plan.md
- 시스템 구성에 WebServer 추가
- 현재 구현 현황 테이블 업데이트
- WebServer 구현 가이드 섹션 추가 (6.3)
- 변경 이력 v1.4 추가

### 6.3 Topic_Reference.md
- 구독 토픽 맵에 `erfx/inspector/result` 추가
- WebServer 섹션 추가 (3.3)
  - 구독 토픽
  - 아키텍처 다이어그램
  - 페이지 및 REST API 목록
  - 설정 예시
- 변경 이력 v1.5 추가

---

## 7. 파일 구조

```
ErfxWebServer/
├── Hubs/
│   └── InspectionHub.cs          # SignalR 허브
├── Pages/
│   ├── Index.razor               # Dashboard
│   ├── Inspections.razor         # 검사 목록
│   └── Live.razor                # 실시간 모니터
├── Services/
│   ├── InspectionService.cs      # DB 조회 (수정)
│   └── MqttClientService.cs      # MQTT 구독 + SignalR
├── Shared/
│   └── NavMenu.razor             # 네비게이션 (수정)
├── wwwroot/
│   └── css/
│       └── site.css              # 다크 테마
├── Program.cs                    # 서비스 등록 (수정)
└── ErfxWebServer.csproj          # 패키지 추가 (수정)
```

---

## 8. 빌드 및 실행

```bash
cd ErfxWebServer
dotnet build    # 0 errors, 0 warnings
dotnet run      # http://localhost:5000
```

### 실시간 모니터 테스트
1. Mosquitto 브로커 실행 (`localhost:1883`)
2. WebServer 실행
3. `/live` 페이지 접속
4. Inspector에서 검사 수행 또는 테스트 메시지 발행:
   ```bash
   mosquitto_pub -t "erfx/inspector/result" -m '{"InvoiceNumber":"TEST001","Result":"OK","ExpectedTotal":5,"ActualTotal":5}'
   ```

---

## 변경 이력

| 시간 | 작업 |
|------|------|
| 22:30 | Blazor UI 구현 시작 |
| 22:45 | Dashboard, Inspections 페이지 완료 |
| 23:00 | MQTT + SignalR 연동 구현 |
| 23:10 | MQTTnet v5 API 마이그레이션 |
| 23:15 | 빌드 오류 수정 완료 |
| 23:20 | ERFX_Integration 문서 업데이트 |
| 23:25 | README.md 업데이트 |
