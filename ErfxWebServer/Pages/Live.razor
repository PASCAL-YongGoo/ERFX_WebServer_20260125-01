@page "/live"
@namespace ErfxWebServer.Pages
@using Microsoft.AspNetCore.SignalR.Client
@inject NavigationManager NavigationManager
@inject MqttClientService MqttService
@inject IInspectionService InspectionService
@implements IAsyncDisposable

<PageTitle>Live Monitor - ERFX</PageTitle>

<h1 class="page-title">Live Monitor</h1>

<!-- Ïó∞Í≤∞ ÏÉÅÌÉú ÌëúÏãú -->
<div class="connection-status @(isConnected ? "connected" : "disconnected")">
    <span class="status-dot"></span>
    <span>MQTT: @(isConnected ? "Connected" : "Disconnected")</span>
</div>

<!-- ÏãúÎÆ¨Î†àÏù¥ÏÖò Ïª®Ìä∏Î°§ Ìå®ÎÑê -->
<div class="simulation-panel">
    <div class="simulation-header">
        <span class="simulation-title">Simulation</span>
        <span class="simulation-hint">Test without MQTT</span>
    </div>
    <div class="simulation-buttons">
        <button class="sim-btn sim-btn-random" @onclick="SimulateRandom" disabled="@isSimulating">
            Random
        </button>
        <button class="sim-btn sim-btn-ok" @onclick="SimulateOk" disabled="@isSimulating">
            OK
        </button>
        <button class="sim-btn sim-btn-ng" @onclick="SimulateNg" disabled="@isSimulating">
            NG
        </button>
    </div>
</div>

<!-- ÏµúÍ∑º Í≤ÄÏÇ¨ Í≤∞Í≥º (ÌÅ∞ Ïπ¥Îìú) -->
@if (latestResult != null)
{
    <div class="latest-result @(latestResult.IsOk ? "result-ok-card" : "result-ng-card")">
        <div class="result-header">
            <span class="result-badge-large @(latestResult.IsOk ? "result-ok" : "result-ng")">
                @latestResult.Result
            </span>
            <span class="result-time">@latestResult.InspectedAtUtc.ToLocalTime().ToString("HH:mm:ss")</span>
        </div>

        @if (latestResult.HasWarning)
        {
            <div class="warning-banner">
                <span class="warning-icon">‚ö†</span>
                <span class="warning-text">@latestResult.WarningMessage</span>
            </div>
        }

        <div class="result-details">
            <div class="detail-row">
                <span class="detail-label">Store</span>
                <span class="detail-value">@(latestResult.StoreCode ?? "-")</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Region</span>
                <span class="detail-value">@(latestResult.Region ?? "-")</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Invoice</span>
                <span class="detail-value">@(latestResult.InvoiceNumber ?? "-")</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Expected</span>
                <span class="detail-value">
                    @latestResult.ExpectedTotal
                    @if (latestResult.DeclaredTotal > 0 && latestResult.DeclaredTotal != latestResult.ExpectedTotal)
                    {
                        <span class="declared-total">(ÏÑ†Ïñ∏: @latestResult.DeclaredTotal)</span>
                    }
                </span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Actual</span>
                <span class="detail-value">@latestResult.ActualTotal</span>
            </div>
            <div class="detail-row">
                <span class="detail-label">Elapsed</span>
                <span class="detail-value">@latestResult.ElapsedMs ms</span>
            </div>
        </div>

        @if (!string.IsNullOrEmpty(latestResult.BarcodeRaw))
        {
            <div class="barcode-raw-section">
                <span class="detail-label">Barcode Raw</span>
                <div class="barcode-raw-value">@latestResult.BarcodeRaw</div>
            </div>
        }

        @if (latestResult.Differences?.Any() == true)
        {
            <div class="differences-section">
                <h4>Differences</h4>
                <table class="differences-table">
                    <thead>
                        <tr>
                            <th>SKU</th>
                            <th>Expected</th>
                            <th>Actual</th>
                            <th>Diff</th>
                        </tr>
                    </thead>
                    <tbody>
                        @foreach (var diff in latestResult.Differences)
                        {
                            <tr>
                                <td>@diff.Sku</td>
                                <td>@diff.Expected</td>
                                <td>@diff.Actual</td>
                                <td class="@(diff.Difference > 0 ? "diff-over" : "diff-under")">
                                    @(diff.Difference > 0 ? "+" : "")@diff.Difference
                                </td>
                            </tr>
                        }
                    </tbody>
                </table>
            </div>
        }

        @if (latestResult.EpcSkuPairs?.Any() == true)
        {
            <div class="epc-section">
                <h4>SKUÎ≥Ñ EPC Î™©Î°ù (@(latestResult.EpcSkuPairs.Count)Í∞ú)</h4>
                @{
                    var groupedEpcs = GetGroupedEpcs(latestResult.EpcSkuPairs);
                    var failedEpcs = GetFailedEpcs(latestResult.EpcSkuPairs);
                }

                @if (failedEpcs.Any())
                {
                    var failedKey = "__FAILED__";
                    var isFailedExpanded = IsSkuExpanded(failedKey, true);
                    var displayedFailedEpcs = isFailedExpanded ? failedEpcs : failedEpcs.Take(MaxEpcDisplay).ToList();
                    var remainingFailedCount = failedEpcs.Count - MaxEpcDisplay;

                    <div class="epc-group epc-group-failed">
                        <div class="epc-group-header clickable" @onclick="() => ToggleSkuExpand(failedKey)">
                            <span class="epc-sku-name failed">
                                <span class="expand-icon">@(isFailedExpanded ? "‚ñº" : "‚ñ∂")</span>
                                Î≥ÄÌôò Ïã§Ìå®
                            </span>
                            <span class="epc-count">@(failedEpcs.Count)Í∞ú</span>
                        </div>
                        @if (isFailedExpanded || failedEpcs.Count <= MaxEpcDisplay)
                        {
                            <div class="epc-list">
                                @foreach (var epc in displayedFailedEpcs)
                                {
                                    <div class="epc-item failed">@epc</div>
                                }
                                @if (!isFailedExpanded && remainingFailedCount > 0)
                                {
                                    <div class="epc-more" @onclick="() => ToggleSkuExpand(failedKey)" @onclick:stopPropagation="true">
                                        +@remainingFailedCount Í∞ú ÎçîÎ≥¥Í∏∞
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }

                @{
                    // NG(Î∂àÏùºÏπò) SKU Î™©Î°ù
                    var ngSkus = latestResult.Differences?.Select(d => d.Sku).ToHashSet() ?? new HashSet<string>();
                    // NG SKUÎ•º Î®ºÏ†Ä, OK SKUÎ•º ÎÇòÏ§ëÏóê Ï†ïÎ†¨
                    var sortedGroups = groupedEpcs
                        .OrderByDescending(g => ngSkus.Contains(g.Key))
                        .ThenBy(g => g.Key);
                }

                @foreach (var group in sortedGroups)
                {
                    var isNg = ngSkus.Contains(group.Key);
                    var diff = latestResult.Differences?.FirstOrDefault(d => d.Sku == group.Key);
                    var expected = latestResult.ExpectedItems?.GetValueOrDefault(group.Key, 0) ?? 0;
                    var isExpanded = IsSkuExpanded(group.Key, isNg);
                    var displayedEpcs = isExpanded ? group.Value : group.Value.Take(MaxEpcDisplay).ToList();
                    var remainingCount = group.Value.Count - MaxEpcDisplay;

                    <div class="epc-group @(isNg ? "epc-group-ng" : "epc-group-ok")">
                        <div class="epc-group-header clickable" @onclick="() => ToggleSkuExpand(group.Key)">
                            <span class="epc-sku-name @(isNg ? "ng" : "ok")">
                                <span class="expand-icon">@(isExpanded ? "‚ñº" : "‚ñ∂")</span>
                                @group.Key
                                @if (isNg && diff != null)
                                {
                                    <span class="sku-diff-badge">@(diff.Difference > 0 ? "+" : "")@diff.Difference</span>
                                }
                            </span>
                            <span class="epc-count">
                                @if (isNg)
                                {
                                    <span class="count-expected">ÏòàÏÉÅ @expected</span>
                                    <span class="count-separator">/</span>
                                }
                                <span class="@(isNg ? "count-actual-ng" : "")">Ïã§Ï†ú @(group.Value.Count)Í∞ú</span>
                            </span>
                        </div>
                        @if (isExpanded || group.Value.Count <= MaxEpcDisplay)
                        {
                            <div class="epc-list">
                                @foreach (var epc in displayedEpcs)
                                {
                                    <div class="epc-item">@epc</div>
                                }
                                @if (!isExpanded && remainingCount > 0)
                                {
                                    <div class="epc-more" @onclick="() => ToggleSkuExpand(group.Key)" @onclick:stopPropagation="true">
                                        +@remainingCount Í∞ú ÎçîÎ≥¥Í∏∞
                                    </div>
                                }
                            </div>
                        }
                    </div>
                }
            </div>
        }
    </div>
}
else
{
    <div class="waiting-message">
        <div class="waiting-icon">üì°</div>
        <div>Waiting for inspection results...</div>
    </div>
}

<!-- ÏµúÍ∑º Í≤ÄÏÇ¨ Ïù¥Î†• -->
<h2 class="section-title">Recent Results</h2>
<div class="history-list">
    @if (recentResults.Count == 0)
    {
        <div class="empty-state">
            <div class="message">No results yet</div>
        </div>
    }
    else
    {
        @foreach (var result in recentResults)
        {
            <div class="history-item @(result.IsOk ? "history-ok" : "history-ng")">
                <span class="history-badge @(result.IsOk ? "result-ok" : "result-ng")">@result.Result</span>
                <span class="history-invoice">@(result.InvoiceNumber ?? "-")</span>
                <span class="history-count">@result.ExpectedTotal / @result.ActualTotal</span>
                <span class="history-time">@result.InspectedAtUtc.ToLocalTime().ToString("HH:mm:ss")</span>
            </div>
        }
    }
</div>

@code {
    private HubConnection? hubConnection;
    private BoxInspectionResult? latestResult;
    private List<BoxInspectionResult> recentResults = new();
    private bool isConnected;
    private const int MaxHistoryCount = 20;
    private const int MaxEpcDisplay = 5;
    private bool isSimulating = false;
    private HashSet<string> expandedSkus = new();
    private HashSet<string> ngSkusCache = new();

    private async Task SimulateRandom() => await SimulateAsync(null);
    private async Task SimulateOk() => await SimulateAsync(true);
    private async Task SimulateNg() => await SimulateAsync(false);

    private async Task SimulateAsync(bool? forceResult)
    {
        if (isSimulating) return;

        isSimulating = true;
        StateHasChanged();

        try
        {
            await InspectionService.SimulateInspectionAsync(forceResult);
            // SignalR Î∏åÎ°úÎìúÏ∫êÏä§Ìä∏Î°ú ÏûêÎèô UI ÏóÖÎç∞Ïù¥Ìä∏Îê®
        }
        finally
        {
            isSimulating = false;
            StateHasChanged();
        }
    }

    protected override async Task OnInitializedAsync()
    {
        isConnected = MqttService.IsConnected;

        hubConnection = new HubConnectionBuilder()
            .WithUrl(NavigationManager.ToAbsoluteUri("/inspectionhub"))
            .WithAutomaticReconnect()
            .Build();

        hubConnection.On<BoxInspectionResult>("InspectionResult", (result) =>
        {
            latestResult = result;

            // ÏÉà Í≤∞Í≥º ÏàòÏã† Ïãú ÌéºÏπ® ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
            ResetExpandState();

            // Ïù¥Î†•Ïóê Ï∂îÍ∞Ä (ÏµúÏã† Í≤ÉÏù¥ ÏúÑÏóê)
            recentResults.Insert(0, result);
            if (recentResults.Count > MaxHistoryCount)
            {
                recentResults.RemoveAt(recentResults.Count - 1);
            }

            InvokeAsync(StateHasChanged);
        });

        hubConnection.On<bool>("MqttConnected", (connected) =>
        {
            isConnected = connected;
            InvokeAsync(StateHasChanged);
        });

        await hubConnection.StartAsync();
    }

    public async ValueTask DisposeAsync()
    {
        if (hubConnection != null)
        {
            await hubConnection.DisposeAsync();
        }
    }

    /// <summary>
    /// EPC-SKU ÏåçÏùÑ SKUÎ≥ÑÎ°ú Í∑∏Î£πÌïë
    /// </summary>
    private Dictionary<string, List<string>> GetGroupedEpcs(List<EpcSkuPair>? pairs)
    {
        if (pairs == null) return new Dictionary<string, List<string>>();

        return pairs
            .Where(p => !string.IsNullOrEmpty(p.Sku))
            .GroupBy(p => p.Sku!)
            .ToDictionary(g => g.Key, g => g.Select(p => p.Epc).ToList());
    }

    /// <summary>
    /// Î≥ÄÌôò Ïã§Ìå®Ìïú EPC Î™©Î°ù Ï∂îÏ∂ú
    /// </summary>
    private List<string> GetFailedEpcs(List<EpcSkuPair>? pairs)
    {
        if (pairs == null) return new List<string>();

        return pairs
            .Where(p => string.IsNullOrEmpty(p.Sku))
            .Select(p => p.Epc)
            .ToList();
    }

    /// <summary>
    /// SKU ÌéºÏπ® ÏÉÅÌÉú ÌôïÏù∏ (NGÎäî Í∏∞Î≥∏ ÌéºÏπ®, OKÎäî Í∏∞Î≥∏ Ï†ëÌûò)
    /// </summary>
    private bool IsSkuExpanded(string sku, bool isNgDefault)
    {
        // Î™ÖÏãúÏ†ÅÏúºÎ°ú ÌÜ†Í∏ÄÌïú Í≤ΩÏö∞ Í∑∏ ÏÉÅÌÉú ÏÇ¨Ïö©
        if (expandedSkus.Contains(sku))
            return !isNgDefault; // ÌÜ†Í∏ÄÌïòÎ©¥ Í∏∞Î≥∏Í∞í Î∞òÏ†Ñ

        // Í∏∞Î≥∏Í∞í: NGÎäî ÌéºÏπ®, OKÎäî Ï†ëÌûò
        return isNgDefault;
    }

    /// <summary>
    /// SKU ÌéºÏπ®/Ï†ëÌûò ÌÜ†Í∏Ä
    /// </summary>
    private void ToggleSkuExpand(string sku)
    {
        if (expandedSkus.Contains(sku))
            expandedSkus.Remove(sku);
        else
            expandedSkus.Add(sku);
    }

    /// <summary>
    /// ÏÉà Í≤∞Í≥º ÏàòÏã† Ïãú ÌéºÏπ® ÏÉÅÌÉú Ï¥àÍ∏∞Ìôî
    /// </summary>
    private void ResetExpandState()
    {
        expandedSkus.Clear();
    }
}

<style>
    /* ========================================
       15.6" FHD Android Monitor ÏµúÏ†ÅÌôî
       - ÌÅ∞ Ìè∞Ìä∏, ÌÑ∞Ïπò ÏπúÌôîÏ†Å UI
       ======================================== */

    .page-title {
        font-size: 36px;
        font-weight: 700;
        margin-bottom: 20px;
    }

    .connection-status {
        display: inline-flex;
        align-items: center;
        gap: 12px;
        padding: 12px 24px;
        border-radius: 24px;
        font-size: 18px;
        font-weight: 600;
        margin-bottom: 20px;
    }

    .connection-status.connected {
        background-color: rgba(16, 185, 129, 0.15);
        color: var(--success);
    }

    .connection-status.disconnected {
        background-color: rgba(239, 68, 68, 0.15);
        color: var(--error);
    }

    .status-dot {
        width: 14px;
        height: 14px;
        border-radius: 50%;
        background-color: currentColor;
        animation: pulse 2s infinite;
    }

    @@keyframes pulse {
        0%, 100% { opacity: 1; }
        50% { opacity: 0.5; }
    }

    .latest-result {
        background-color: var(--bg-card);
        border-radius: 12px;
        padding: 28px;
        margin-bottom: 28px;
        border-left: 8px solid;
    }

    .result-ok-card {
        border-left-color: var(--success);
    }

    .result-ng-card {
        border-left-color: var(--error);
    }

    .result-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 24px;
    }

    .result-badge-large {
        font-size: 48px;
        padding: 16px 48px;
        font-weight: 800;
        letter-spacing: 4px;
        border-radius: 12px;
    }

    .result-time {
        color: var(--text-secondary);
        font-size: 22px;
        font-weight: 500;
    }

    .result-details {
        display: grid;
        grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
        gap: 20px;
        margin-bottom: 24px;
    }

    .detail-row {
        display: flex;
        flex-direction: column;
        gap: 6px;
    }

    .detail-label {
        font-size: 14px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 600;
        letter-spacing: 0.5px;
    }

    .detail-value {
        font-size: 26px;
        font-weight: 700;
        color: var(--text-primary);
    }

    .differences-section {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 2px solid var(--border-color);
    }

    .differences-section h4 {
        margin: 0 0 16px 0;
        color: var(--text-secondary);
        font-size: 20px;
        font-weight: 600;
    }

    .differences-table {
        width: 100%;
        border-collapse: collapse;
    }

    .differences-table th,
    .differences-table td {
        padding: 14px 18px;
        text-align: left;
        border-bottom: 1px solid var(--border-color);
        font-size: 18px;
    }

    .differences-table th {
        font-size: 14px;
        color: var(--text-secondary);
        text-transform: uppercase;
        font-weight: 700;
    }

    .differences-table td {
        font-weight: 500;
    }

    .diff-over {
        color: var(--warning);
        font-weight: 700;
    }

    .diff-under {
        color: var(--error);
        font-weight: 700;
    }

    .waiting-message {
        text-align: center;
        padding: 80px 30px;
        color: var(--text-muted);
        background-color: var(--bg-card);
        border-radius: 12px;
        margin-bottom: 28px;
        font-size: 22px;
    }

    .waiting-icon {
        font-size: 72px;
        margin-bottom: 20px;
        animation: pulse 2s infinite;
    }

    .section-title {
        font-size: 24px;
        color: var(--text-secondary);
        margin-bottom: 20px;
        font-weight: 600;
    }

    .history-list {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }

    .history-item {
        display: flex;
        align-items: center;
        gap: 20px;
        padding: 16px 20px;
        background-color: var(--bg-card);
        border-radius: 10px;
        border-left: 5px solid;
    }

    .history-ok {
        border-left-color: var(--success);
    }

    .history-ng {
        border-left-color: var(--error);
    }

    .history-badge {
        font-size: 16px;
        padding: 6px 14px;
        font-weight: 700;
    }

    .history-invoice {
        flex: 1;
        font-weight: 600;
        font-size: 18px;
    }

    .history-count {
        color: var(--text-secondary);
        font-size: 18px;
        font-weight: 500;
    }

    .history-time {
        color: var(--text-muted);
        font-size: 16px;
    }

    .simulation-panel {
        background-color: var(--bg-card, #1f2937);
        border-radius: 12px;
        padding: 20px;
        margin-bottom: 24px;
        border: 3px dashed #7c3aed;
        display: block !important;
    }

    .simulation-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        margin-bottom: 16px;
    }

    .simulation-title {
        font-weight: 700;
        font-size: 20px;
        color: var(--text-primary);
    }

    .simulation-hint {
        font-size: 16px;
        color: var(--text-muted);
    }

    .simulation-buttons {
        display: flex;
        gap: 16px;
    }

    .sim-btn {
        padding: 16px 36px;
        border-radius: 10px;
        border: none;
        cursor: pointer;
        font-weight: 700;
        font-size: 18px;
        transition: all 0.2s ease;
        min-height: 56px;
    }

    .sim-btn:disabled {
        opacity: 0.5;
        cursor: not-allowed;
    }

    .sim-btn-random {
        background-color: var(--bg-secondary, #16213e);
        color: var(--text-primary, #e5e7eb);
        border: 2px solid var(--border-color, #374151);
    }

    .sim-btn-random:hover:not(:disabled) {
        background-color: var(--bg-hover, #374151);
    }

    .sim-btn-ok {
        background-color: var(--success, #10b981);
        color: white;
    }

    .sim-btn-ok:hover:not(:disabled) {
        filter: brightness(1.1);
    }

    .sim-btn-ng {
        background-color: var(--error, #ef4444);
        color: white;
    }

    .sim-btn-ng:hover:not(:disabled) {
        filter: brightness(1.1);
    }

    /* Barcode Raw Section */
    .barcode-raw-section {
        margin-top: 20px;
        padding-top: 20px;
        border-top: 2px solid var(--border-color, #374151);
    }

    .barcode-raw-value {
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 16px;
        color: var(--text-secondary, #9ca3af);
        background-color: var(--bg-secondary, #16213e);
        padding: 14px 18px;
        border-radius: 8px;
        margin-top: 8px;
        word-break: break-all;
        line-height: 1.6;
    }

    /* EPC Section Styles */
    .epc-section {
        margin-top: 24px;
        padding-top: 24px;
        border-top: 2px solid var(--border-color, #374151);
    }

    .epc-section h4 {
        margin: 0 0 20px 0;
        color: var(--text-secondary, #9ca3af);
        font-size: 20px;
        font-weight: 600;
    }

    .epc-group {
        background-color: var(--bg-secondary, #16213e);
        border-radius: 10px;
        margin-bottom: 16px;
        overflow: hidden;
    }

    .epc-group-failed {
        border: 2px solid var(--error, #ef4444);
    }

    .epc-group-ng {
        border: 2px solid var(--error, #ef4444);
        background-color: rgba(239, 68, 68, 0.08);
    }

    .epc-group-ok {
        border: 2px solid var(--success, #10b981);
    }

    .epc-group-header {
        display: flex;
        justify-content: space-between;
        align-items: center;
        padding: 14px 18px;
        background-color: rgba(255, 255, 255, 0.05);
        border-bottom: 1px solid var(--border-color, #374151);
        min-height: 56px;
    }

    .epc-sku-name {
        font-weight: 700;
        font-size: 18px;
        color: var(--text-primary, #e5e7eb);
        font-family: 'Consolas', 'Monaco', monospace;
    }

    .epc-sku-name.failed {
        color: var(--error, #ef4444);
    }

    .epc-sku-name.ng {
        color: var(--error, #ef4444);
    }

    .epc-sku-name.ok {
        color: var(--success, #10b981);
    }

    .sku-diff-badge {
        display: inline-block;
        font-size: 14px;
        padding: 4px 10px;
        margin-left: 12px;
        border-radius: 12px;
        background-color: var(--error, #ef4444);
        color: white;
        font-weight: 700;
    }

    .count-expected {
        color: var(--text-muted, #6b7280);
        font-size: 16px;
    }

    .count-separator {
        margin: 0 6px;
        color: var(--text-muted, #6b7280);
    }

    .count-actual-ng {
        color: var(--error, #ef4444);
        font-weight: 700;
        font-size: 16px;
    }

    .epc-count {
        font-size: 16px;
        color: var(--text-muted, #6b7280);
        background-color: rgba(255, 255, 255, 0.1);
        padding: 6px 14px;
        border-radius: 14px;
        font-weight: 500;
    }

    .epc-list {
        padding: 12px 18px;
        max-height: 240px;
        overflow-y: auto;
    }

    .epc-item {
        font-family: 'Consolas', 'Monaco', monospace;
        font-size: 15px;
        color: var(--text-secondary, #9ca3af);
        padding: 8px 12px;
        margin: 4px 0;
        background-color: rgba(0, 0, 0, 0.2);
        border-radius: 6px;
        word-break: break-all;
    }

    .epc-item.failed {
        color: var(--error, #ef4444);
        background-color: rgba(239, 68, 68, 0.1);
    }

    .epc-item:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    /* Expand/Collapse Styles */
    .epc-group-header.clickable {
        cursor: pointer;
        user-select: none;
        transition: background-color 0.15s ease;
    }

    .epc-group-header.clickable:hover {
        background-color: rgba(255, 255, 255, 0.1);
    }

    .epc-group-header.clickable:active {
        background-color: rgba(255, 255, 255, 0.15);
    }

    .expand-icon {
        display: inline-block;
        width: 24px;
        font-size: 14px;
        color: var(--text-muted, #6b7280);
        margin-right: 10px;
        transition: transform 0.15s ease;
    }

    .epc-more {
        font-size: 16px;
        color: var(--accent-blue, #3b82f6);
        padding: 14px 18px;
        text-align: center;
        cursor: pointer;
        background-color: rgba(59, 130, 246, 0.1);
        border-radius: 8px;
        margin: 6px 0;
        transition: background-color 0.15s ease;
        font-weight: 600;
        min-height: 48px;
        display: flex;
        align-items: center;
        justify-content: center;
    }

    .epc-more:hover {
        background-color: rgba(59, 130, 246, 0.2);
    }

    .epc-more:active {
        background-color: rgba(59, 130, 246, 0.3);
    }

    /* Warning Banner */
    .warning-banner {
        display: flex;
        align-items: center;
        gap: 14px;
        padding: 16px 20px;
        margin-bottom: 20px;
        background-color: rgba(245, 158, 11, 0.15);
        border: 2px solid var(--warning, #f59e0b);
        border-radius: 10px;
        color: var(--warning, #f59e0b);
    }

    .warning-icon {
        font-size: 28px;
    }

    .warning-text {
        font-size: 18px;
        line-height: 1.5;
        font-weight: 500;
    }

    /* Declared Total (mismatch indicator) */
    .declared-total {
        font-size: 16px;
        color: var(--warning, #f59e0b);
        margin-left: 10px;
        font-weight: 500;
    }

    /* Touch-friendly scrollbar for Android */
    ::-webkit-scrollbar {
        width: 12px;
    }

    ::-webkit-scrollbar-track {
        background: var(--bg-secondary, #16213e);
        border-radius: 6px;
    }

    ::-webkit-scrollbar-thumb {
        background: var(--border-color, #374151);
        border-radius: 6px;
    }

    ::-webkit-scrollbar-thumb:hover {
        background: var(--text-muted, #6b7280);
    }
</style>
