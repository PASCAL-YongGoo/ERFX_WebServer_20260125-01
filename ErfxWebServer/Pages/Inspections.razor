@page "/inspections"
@namespace ErfxWebServer.Pages
@inject IInspectionService InspectionService

<PageTitle>Inspection Results - ERFX</PageTitle>

<h1 class="page-title">Inspection Results</h1>

@if (isLoading)
{
    <div class="loading-container">
        <div class="loading-spinner"></div>
        <span>Loading inspection results...</span>
    </div>
}
else if (errorMessage != null)
{
    <div class="error-container">
        <div class="error-title">Error Loading Data</div>
        <div>@errorMessage</div>
    </div>
}
else if (inspections == null || inspections.Count == 0)
{
    <div class="empty-state">
        <div class="icon">ðŸ“‹</div>
        <div class="message">No inspection results found</div>
    </div>
}
else
{
    <table class="inspection-table">
        <thead>
            <tr>
                <th>ID</th>
                <th>Invoice Number</th>
                <th>Inspection Time</th>
                <th>Expected</th>
                <th>Actual</th>
                <th>Result</th>
            </tr>
        </thead>
        <tbody>
            @foreach (var item in inspections)
            {
                <tr>
                    <td>@item.Id</td>
                    <td>@(item.InvoiceNumber ?? "-")</td>
                    <td>@item.InspectedAtUtc.ToLocalTime().ToString("yyyy-MM-dd HH:mm:ss")</td>
                    <td>@item.ExpectedTotal</td>
                    <td>@item.ActualTotal</td>
                    <td>
                        <span class="result-badge @(item.IsOk ? "result-ok" : "result-ng")">
                            @item.Result
                        </span>
                    </td>
                </tr>
            }
        </tbody>
    </table>
    
    <div class="pagination">
        <button class="pagination-btn" @onclick="PreviousPage" disabled="@(currentPage <= 1)">
            &laquo; Previous
        </button>
        <span class="pagination-info">
            Page @currentPage of @totalPages (@totalCount total)
        </span>
        <button class="pagination-btn" @onclick="NextPage" disabled="@(currentPage >= totalPages)">
            Next &raquo;
        </button>
    </div>
}

@code {
    private List<BoxInspectionResult>? inspections;
    private bool isLoading = true;
    private string? errorMessage;
    
    private int currentPage = 1;
    private int pageSize = 20;
    private int totalCount = 0;
    private int totalPages => (int)Math.Ceiling((double)totalCount / pageSize);

    protected override async Task OnInitializedAsync()
    {
        await LoadInspections();
    }

    private async Task LoadInspections()
    {
        try
        {
            isLoading = true;
            errorMessage = null;
            
            totalCount = await InspectionService.GetTotalCountAsync();
            inspections = await InspectionService.GetAllAsync(currentPage, pageSize);
        }
        catch (Exception ex)
        {
            errorMessage = $"Failed to load inspections: {ex.Message}";
        }
        finally
        {
            isLoading = false;
        }
    }

    private async Task PreviousPage()
    {
        if (currentPage > 1)
        {
            currentPage--;
            await LoadInspections();
        }
    }

    private async Task NextPage()
    {
        if (currentPage < totalPages)
        {
            currentPage++;
            await LoadInspections();
        }
    }
}
